<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Proyecto - TaskFlow</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Estilos dinámicos necesarios */
        .kanban-column {
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }
        .column-content {
            flex-grow: 1;
            min-height: 50px;
        }
        .kanban-card.dragging {
            opacity: 0.5;
            border: 2px dashed #8D47F0;
        }
        .user-logged-area {
            display: flex; align-items: center; gap: 15px; color: white;
        }
        .notification-item { border-bottom: 1px solid #eee; padding: 10px; font-size: 0.9rem; }
        .notification-time { font-size: 0.75rem; color: #888; display: block; margin-top: 4px; }
        .role-selector { padding: 5px; border-radius: 4px; border: 1px solid #ddd; width: 100%; }
        
        /* Botones de eliminar */
        .delete-col-btn {
            background: none; border: none; color: #e74c3c; cursor: pointer; margin-left: 10px;
        }
        .delete-col-btn:hover { color: #c0392b; }

        .delete-member-btn {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
        }
        .delete-member-btn:hover {
            background-color: #c62828;
            color: white;
        }
    </style>
</head>

<body>

    <header class="header project-header">
        <a href="index.html">
            <img src="logo.png" class="logo-rex" alt="Logo Rex">
        </a>

        <div class="search-bar project-search-bar">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Filtrar tareas..." onkeyup="filtrarTareasUI()">
        </div>

        <div class="member-interaction-area" id="memberListContainer" onclick="openMemberListModal()">
            <img src="miembros.png" class="miembros" alt="Miembros del equipo">
            <i class="fas fa-plus fa-lg mas-miembros"></i>
        </div>

        <div class="project-user-actions">
            <button class="btn primary-btn btn-small" onclick="openInviteMemberModal()">
                Invitar miembro
            </button>
            <a href="index.html" class="btn secondary-btn btn-small">
                Mis Proyectos
            </a>
        </div>

        <div class="actions project-user-actions">
            <div style="position: relative;">
                <i class="fas fa-bell notification-icon" style="scale: 1.3; margin-right: 25px;" onclick="toggleNotificationPopover()"></i>
                <span id="notifBadge" style="display:none; position: absolute; top: -5px; right: 15px; background: red; color: white; border-radius: 50%; font-size: 10px; padding: 2px 5px;">0</span>
            </div>
            
            <div class="user-logged-area">
                <span id="headerUserName">Usuario</span>
                <i class="fas fa-user-circle" style="scale: 2.5; margin-left: 10px;"></i>
            </div>
        </div>
    </header>

    <main class="main-content kanban-board-container">
        <div class="kanban-board" id="kanbanBoard">
            <p style="padding: 20px; color: #666;">Cargando datos del proyecto...</p>
        </div>
    </main>

    <div id="addItemModal" class="modal-overlay">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2 id="modalTaskTitle"><i class="fas fa-tasks"></i> Gestión de Tarea</h2>
                <button class="modal-close-btn" onclick="closeAddItemModal()">&times;</button>
            </div>
            <form class="modal-body add-item-form-grid" onsubmit="guardarTarea(event)">
                <input type="hidden" id="taskId">
                <input type="hidden" id="taskProjectId">
                <input type="hidden" id="taskStatusId">

                <div class="form-left-col">
                    <div class="input-group">
                        <label>Título de la Tarea</label>
                        <div class="input-with-icon">
                            <input type="text" id="taskTitle" required placeholder="Ej: Corregir bug login">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Descripción</label>
                        <textarea id="taskDescription" class="modal-text-area" style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;"></textarea>
                    </div>

                    <div class="input-group">
                        <label>Asignar a:</label>
                        <select id="taskAssignee" class="input-with-icon" style="width: 100%;">
                            </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Fecha Vencimiento:</label>
                        <input type="date" id="taskDueDate" class="input-with-icon" style="width: 100%;">
                    </div>
                </div>

                <div class="image-upload-area">
                    <i class="fas fa-camera fa-2x" style="color: #ccc;"></i>
                    <p style="margin-top: 10px; color: #666;">Imagen (Simulado)</p>
                </div>

                <div style="grid-column: 1 / -1; display: flex; justify-content: space-between; margin-top: 20px;">
                    <button type="button" class="btn btn-danger" id="btnDeleteTask" style="background-color: #e74c3c; color: white; display: none;" onclick="eliminarTarea()">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                    <button type="submit" class="btn primary-btn">Guardar Tarea</button>
                </div>
            </form>
        </div>
    </div>

    <div id="inviteMemberModal" class="modal-overlay">
        <div class="modal-content small-modal">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Invitar Miembro</h2>
                <button class="modal-close-btn" onclick="closeInviteMemberModal()">&times;</button>
            </div>
            <form class="modal-body" onsubmit="crearMiembro(event)">
                <div class="input-group">
                    <label>Nombre</label>
                    <input type="text" id="newMemberName" class="input-with-icon" required placeholder="Nombre completo" style="width: 100%;">
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="newMemberEmail" class="input-with-icon" required placeholder="correo@ejemplo.com" style="width: 100%;">
                </div>
                <div class="input-group">
                    <label>Contraseña Provisional</label>
                    <input type="password" id="newMemberPass" class="input-with-icon" required placeholder="********" style="width: 100%;">
                </div>

                <button type="submit" class="btn primary-btn full-width-btn" style="margin-top: 20px;">
                    Crear Usuario
                </button>
            </form>
        </div>
    </div>

    <div id="memberListModal" class="modal-overlay">
        <div class="modal-content small-modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fas fa-users"></i> Equipo</h2>
                <button class="modal-close-btn" onclick="closeMemberListModal()">&times;</button>
            </div>
            <div class="modal-body" id="memberListBody" style="max-height: 400px; overflow-y: auto;">
                </div>
        </div>
    </div>

    <div id="addColumnModal" class="modal-overlay">
        <div class="modal-content small-modal">
            <div class="modal-header">
                <h2><i class="fas fa-columns"></i> Nueva Columna</h2>
                <button class="modal-close-btn" onclick="closeAddColumnModal()">&times;</button>
            </div>
            <form class="modal-body" onsubmit="crearColumna(event)">
                <div class="input-group">
                    <label>Nombre del Estado</label>
                    <input type="text" id="columnName" class="input-with-icon" required placeholder="Ej: Testing" style="width: 100%;">
                </div>
                <button type="submit" class="btn primary-btn" style="width: 100%; margin-top: 15px;">Crear Columna</button>
            </form>
        </div>
    </div>

    <div class="notification-popover" id="notificationPopover" style="display: none;">
        <div class="popover-header">
            <h3>Actividad Reciente</h3>
            <span class="close-popover-btn" onclick="toggleNotificationPopover()">&times;</span>
        </div>
        <div class="popover-body" id="notificationList">
            <p style="padding: 10px; color: #666;">Sin notificaciones aún.</p>
        </div>
    </div>


    <script>
        const API_BASE = 'http://localhost:8080/api';
        
        // Variables Globales
        let currentProjectId = 1;
        let currentUser = null;
        
        let tasks = [];
        let members = [];
        let roles = [];
        let statuses = [];

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', async () => {
            const userStr = localStorage.getItem('usuarioLogueado');
            if (!userStr) {
                alert("Debes iniciar sesión primero.");
                window.location.href = 'iniciarSesion.html';
                return;
            }
            currentUser = JSON.parse(userStr);
            document.getElementById('headerUserName').textContent = currentUser.nombre;

            const urlParams = new URLSearchParams(window.location.search);
            const idParam = urlParams.get('id');
            if (idParam) currentProjectId = idParam;

            await cargarDatosMaestros();
            await cargarTablero();
            renderNotificaciones();
        });

        // --- CARGA DE DATOS ---
        async function cargarDatosMaestros() {
            try {
                const [resEst, resMiem, resRol] = await Promise.all([
                    fetch(`${API_BASE}/estados`),
                    fetch(`${API_BASE}/miembros`),
                    fetch(`${API_BASE}/roles`)
                ]);
                statuses = await resEst.json();
                members = await resMiem.json();
                roles = await resRol.json();
            } catch (error) {
                console.error("Error cargando maestros:", error);
            }
        }

        async function cargarTablero() {
            try {
                const res = await fetch(`${API_BASE}/tareas`);
                const todas = await res.json();
                tasks = todas.filter(t => t.proyectoId == currentProjectId);
                renderizarKanban();
            } catch (error) { console.error(error); }
        }

        // --- RENDERIZADO KANBAN ---
        function renderizarKanban() {
            const board = document.getElementById('kanbanBoard');
            board.innerHTML = '';

            statuses.forEach(estado => {
                const tareasDeColumna = tasks.filter(t => t.estadoId === estado.estadoId);
                const colDiv = document.createElement('div');
                colDiv.className = 'kanban-column';
                colDiv.dataset.statusId = estado.estadoId;

                colDiv.addEventListener('dragover', e => { e.preventDefault(); colDiv.classList.add('drag-over'); });
                colDiv.addEventListener('dragleave', () => colDiv.classList.remove('drag-over'));
                colDiv.addEventListener('drop', e => soltarTarea(e, estado.estadoId));

                colDiv.innerHTML = `
                    <div class="column-header">
                        <h3>${estado.nombre} <span style="font-size:0.8em; color:#666">(${tareasDeColumna.length})</span></h3>
                        <div class="column-menu">
                            <button class="delete-col-btn" title="Eliminar columna" onclick="eliminarColumna(${estado.estadoId})">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="column-content"></div>
                    <button class="btn add-item-btn" onclick="openAddItemModal(${estado.estadoId})">
                        <i class="fas fa-plus"></i> Añadir tarea
                    </button>
                `;

                const contentDiv = colDiv.querySelector('.column-content');
                tareasDeColumna.forEach(tarea => {
                    contentDiv.appendChild(crearTarjetaHTML(tarea));
                });
                board.appendChild(colDiv);
            });

            const addColDiv = document.createElement('div');
            addColDiv.className = 'add-column-placeholder';
            addColDiv.innerHTML = `<button class="btn add-column-btn mas-columnas" onclick="openAddColumnModal()"><i class="fas fa-plus fa-lg"></i></button>`;
            board.appendChild(addColDiv);
        }

        function crearTarjetaHTML(tarea) {
            const card = document.createElement('div');
            card.className = 'kanban-card';
            card.draggable = true;
            card.dataset.taskId = tarea.tareaId;

            const asignado = members.find(m => m.miembroId === tarea.asignadoA);
            const iniciales = asignado ? asignado.nombre.substring(0, 2).toUpperCase() : '?';

            card.addEventListener('dragstart', (e) => {
                card.classList.add('dragging');
                e.dataTransfer.setData('text/plain', tarea.tareaId);
            });
            card.addEventListener('dragend', () => card.classList.remove('dragging'));
            card.onclick = () => openEditTaskModal(tarea);

            card.innerHTML = `
                <div class="card-image-kanban" style="background-color: ${getColorRandom(tarea.tareaId)}"><i class="fas fa-tasks"></i></div>
                <div class="card-title-kanban">${tarea.titulo}</div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                    <span style="font-size:0.7rem; color:#888;">${tarea.fechaVencimiento || 'Sin fecha'}</span>
                    <div class="member-avatar" style="width:25px; height:25px; font-size:0.7rem; background:#8D47F0;">${iniciales}</div>
                </div>
            `;
            return card;
        }

        // --- ACCIONES TAREAS ---
        async function soltarTarea(e, nuevoEstadoId) {
            e.preventDefault();
            const tareaId = e.dataTransfer.getData('text/plain');
            const tarea = tasks.find(t => t.tareaId == tareaId);
            
            if (tarea && tarea.estadoId !== nuevoEstadoId) {
                tarea.estadoId = nuevoEstadoId;
                renderizarKanban();
                try {
                    await fetch(`${API_BASE}/tareas/${tareaId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(tarea)
                    });
                    registrarNotificacion(`Tarea <b>"${tarea.titulo}"</b> movida`);
                } catch (err) { console.error(err); }
            }
        }

        async function guardarTarea(e) {
            e.preventDefault();
            const id = document.getElementById('taskId').value;
            const isEdit = !!id;
            const datos = {
                titulo: document.getElementById('taskTitle').value,
                descripcion: document.getElementById('taskDescription').value,
                fechaVencimiento: document.getElementById('taskDueDate').value || null,
                asignadoA: document.getElementById('taskAssignee').value || null,
                proyectoId: document.getElementById('taskProjectId').value,
                estadoId: document.getElementById('taskStatusId').value
            };
            const url = isEdit ? `${API_BASE}/tareas/${id}` : `${API_BASE}/tareas`;
            const method = isEdit ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });
                if (res.ok) {
                    closeAddItemModal();
                    await cargarTablero();
                    registrarNotificacion(`${isEdit ? 'Editó' : 'Creó'} tarea <b>"${datos.titulo}"</b>`);
                }
            } catch (err) { console.error(err); }
        }

        async function eliminarTarea() {
            const id = document.getElementById('taskId').value;
            if (!confirm("¿Eliminar tarea?")) return;
            try {
                await fetch(`${API_BASE}/tareas/${id}`, { method: 'DELETE' });
                closeAddItemModal();
                await cargarTablero();
                registrarNotificacion("Tarea eliminada");
            } catch (err) { console.error(err); }
        }

        // --- ACCIONES COLUMNAS ---
        async function crearColumna(e) {
            e.preventDefault();
            const nombre = document.getElementById('columnName').value;
            try {
                const res = await fetch(`${API_BASE}/estados`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre })
                });
                if (res.ok) {
                    closeAddColumnModal();
                    await cargarDatosMaestros();
                    await cargarTablero();
                    registrarNotificacion(`Columna <b>${nombre}</b> creada`);
                }
            } catch (err) { console.error(err); }
        }

        async function eliminarColumna(id) {
            if(!confirm("¿Eliminar columna? Solo se permite si está vacía.")) return;
            try {
                const res = await fetch(`${API_BASE}/estados/${id}`, { method: 'DELETE' });
                if(res.ok) {
                    await cargarDatosMaestros();
                    await cargarTablero();
                    registrarNotificacion("Columna eliminada");
                } else { alert("Error: La columna debe estar vacía."); }
            } catch(e) { console.error(e); }
        }

        // --- ACCIONES MIEMBROS ---
        async function crearMiembro(e) {
            e.preventDefault();
            const data = {
                nombre: document.getElementById('newMemberName').value,
                email: document.getElementById('newMemberEmail').value,
                contrasenaHash: document.getElementById('newMemberPass').value,
                rolId: 3,
                fechaRegistro: new Date().toISOString()
            };
            try {
                const res = await fetch(`${API_BASE}/miembros`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    closeInviteMemberModal();
                    await cargarDatosMaestros();
                    registrarNotificacion(`Usuario <b>${data.nombre}</b> añadido`);
                } else { alert("Error: Email duplicado."); }
            } catch (err) { console.error(err); }
        }

        async function cambiarRol(miembroId, nuevoRolId, nombre) {
            const miembro = members.find(m => m.miembroId === miembroId);
            if (!miembro) return;
            miembro.rolId = parseInt(nuevoRolId);
            try {
                await fetch(`${API_BASE}/miembros/${miembroId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(miembro)
                });
                registrarNotificacion(`Rol de <b>${nombre}</b> actualizado`);
            } catch (err) { console.error(err); }
        }

        // FUNCIÓN ELIMINAR MIEMBRO (NUEVA)
        async function eliminarMiembro(id, nombre) {
            if(!confirm(`¿Estás seguro de que quieres eliminar a ${nombre} del equipo?`)) return;

            try {
                const res = await fetch(`${API_BASE}/miembros/${id}`, {
                    method: 'DELETE'
                });

                if(res.ok) {
                    await cargarDatosMaestros(); // Recargar la lista local
                    openMemberListModal(); // Refrescar el modal abierto
                    registrarNotificacion(`Eliminó al miembro <b>${nombre}</b>`);
                } else {
                    alert("No se pudo eliminar al miembro. Puede que tenga tareas asignadas.");
                }
            } catch(error) {
                console.error(error);
                alert("Error de conexión al intentar eliminar.");
            }
        }

        // --- MODALES MIEMBROS Y UI ---
        const memberListModal = document.getElementById('memberListModal');
        function openMemberListModal() {
            const body = document.getElementById('memberListBody');
            body.innerHTML = '';
            members.forEach(m => {
                let options = '';
                roles.forEach(r => {
                    options += `<option value="${r.rolId}" ${m.rolId===r.rolId?'selected':''}>${r.nombre}</option>`;
                });
                
                // Verificamos si es el usuario actual para no mostrar el botón de borrarse a sí mismo
                const esYo = (m.miembroId === currentUser.miembroId);
                const botonEliminar = esYo ? '' : 
                    `<button class="delete-member-btn" title="Eliminar miembro" onclick="eliminarMiembro(${m.miembroId}, '${m.nombre}')">
                        <i class="fas fa-trash-alt"></i>
                     </button>`;

                body.innerHTML += `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                        <div style="flex-grow:1;">
                            <div style="font-weight:bold;">${m.nombre} ${esYo ? '(Tú)' : ''}</div>
                            <div style="font-size:0.8rem; color:#888;">${m.email}</div>
                        </div>
                        <div style="display:flex; align-items:center;">
                            <select class="role-selector" style="width:120px;" onchange="cambiarRol(${m.miembroId}, this.value, '${m.nombre}')">
                                ${options}
                            </select>
                            ${botonEliminar}
                        </div>
                    </div>
                `;
            });
            memberListModal.style.display = 'flex';
        }

        // --- NOTIFICACIONES ---
        function registrarNotificacion(mensaje) {
            const lista = JSON.parse(localStorage.getItem('notificaciones') || '[]');
            lista.unshift({ user: currentUser.nombre, msg: mensaje, time: new Date().toLocaleTimeString() });
            localStorage.setItem('notificaciones', JSON.stringify(lista.slice(0, 15)));
            renderNotificaciones();
            const badge = document.getElementById('notifBadge');
            badge.textContent = parseInt(badge.textContent || 0) + 1;
            badge.style.display = 'block';
        }
        function renderNotificaciones() {
            const lista = JSON.parse(localStorage.getItem('notificaciones') || '[]');
            const container = document.getElementById('notificationList');
            container.innerHTML = lista.length ? '' : '<p style="padding:10px; color:#666;">Sin actividad.</p>';
            lista.forEach(n => {
                container.innerHTML += `<div class="notification-item"><span style="font-weight:bold; color:#8D47F0;">${n.user}</span>: ${n.msg}<span class="notification-time">${n.time}</span></div>`;
            });
        }
        function toggleNotificationPopover() {
            const pop = document.getElementById('notificationPopover');
            if(pop.style.display === 'none') { pop.style.display = 'block'; document.getElementById('notifBadge').style.display = 'none'; document.getElementById('notifBadge').textContent='0'; }
            else pop.style.display = 'none';
        }

        // --- UTILIDADES ---
        const addItemModal = document.getElementById('addItemModal');
        function openAddItemModal(statusId) {
            document.querySelector('.add-item-form-grid').reset();
            document.getElementById('taskId').value = '';
            document.getElementById('taskProjectId').value = currentProjectId;
            document.getElementById('taskStatusId').value = statusId;
            document.getElementById('btnDeleteTask').style.display = 'none';
            document.getElementById('modalTaskTitle').innerHTML = '<i class="fas fa-plus"></i> Nueva Tarea';
            llenarSelectMiembros();
            addItemModal.style.display = 'flex';
        }
        function openEditTaskModal(tarea) {
            document.getElementById('taskId').value = tarea.tareaId;
            document.getElementById('taskProjectId').value = tarea.proyectoId;
            document.getElementById('taskStatusId').value = tarea.estadoId;
            document.getElementById('taskTitle').value = tarea.titulo;
            document.getElementById('taskDescription').value = tarea.descripcion || '';
            document.getElementById('taskDueDate').value = tarea.fechaVencimiento || '';
            document.getElementById('btnDeleteTask').style.display = 'block';
            document.getElementById('modalTaskTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Tarea';
            llenarSelectMiembros(tarea.asignadoA);
            addItemModal.style.display = 'flex';
        }
        function llenarSelectMiembros(selId) {
            const sel = document.getElementById('taskAssignee');
            sel.innerHTML = '<option value="">-- Sin Asignar --</option>';
            members.forEach(m => sel.innerHTML += `<option value="${m.miembroId}" ${m.miembroId===selId?'selected':''}>${m.nombre}</option>`);
        }
        function closeAddItemModal() { addItemModal.style.display = 'none'; }
        function closeInviteMemberModal() { document.getElementById('inviteMemberModal').style.display = 'none'; }
        function openInviteMemberModal() { document.getElementById('inviteMemberModal').style.display = 'flex'; }
        function closeMemberListModal() { memberListModal.style.display = 'none'; }
        function openAddColumnModal() { document.getElementById('addColumnModal').style.display = 'flex'; }
        function closeAddColumnModal() { document.getElementById('addColumnModal').style.display = 'none'; }
        window.onclick = e => { if(e.target.classList.contains('modal-overlay')) e.target.style.display = 'none'; }
        function filtrarTareasUI() {
            const txt = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.kanban-card').forEach(c => c.style.display = c.textContent.toLowerCase().includes(txt)?'block':'none');
        }
        function getColorRandom(id) { return ['#E74C3C','#3498DB','#2ECC71','#F1C40F','#9B59B6'][id%5]; }
    </script>
</body>
</html>